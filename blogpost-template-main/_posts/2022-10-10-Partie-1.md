---
layout: post
title: Partie 1
---

Dans ce turoriel nous allons regarder comment télécharger les données play-by-play de la NHL depuis https://statsapi.web.nhl.com.


Les données pour chacune des parties sont stockées sous un format json et sont accessibles à https://statsapi.web.nhl.com/api/v1/game/[GAME_ID]/feed/live/.

Pour accèder aux données d'une partie précise il faut simplement remplacer GAME_ID par l'identifiant de la partie. 
Allez jeter un coup d'oeil au fichier json de la partie d'ouverture de la saison 2018: [2018020001](https://statsapi.web.nhl.com/api/v1/game/2018020001/feed/live/).

Comment télécharger ce json?

```python
import requests

game_id = 2018020001

url = f'https://statsapi.web.nhl.com/api/v1/game/{game_id}/feed/live/'

response = requests.get(url)
        
json = response.json

```

Pour les étapes suivantes utilisons ce code pour créer une fonction qui retourne le fichier json d'une partie si elle a déjà été téléchargée ou bien la télécharge.
```python
import requests
import os
import json
def get_game(game_id: int,out_dir:str) -> json:
       
        path = os.path.join(out_dir, game_id + '.json')
        
        if os.path.exists(path):
            with open(path) as f:
                return json.load(f)

        url = f'https://statsapi.web.nhl.com/api/v1/game/{game_id}/feed/live/'

        response = requests.get(url)
        
        with open(path,'+w') as f:
            f.write(response.text)

        return response.json
```

Maintenant comment télécharger les parties de la saison régulière?

Regardons comment l'id des parties est créer. En prenant pour exemple 2018020001.

Les 4 premiers chiffres (2018) représente la saison, ici la saison 2018-2019.
Les 2 chiffres suivant (02) représentent le type de partie, ici 02 représente les parties de la saison régulière.
Les 4 derniers chiffres (0001) représentent le numéro de la partie, ici il s'agit de la première partie donc 0001.

Dans une saison régulière on compte normalement 1230 parties et 1271 parties à partir de la saison 2017-2018 ( 31 équipes au lieu de 30).
La saison 2020-2021 fait exception due à la pandémie de covid-19, cette saison ne comptait que 868 parties.

Avec ces informations on peut écrire une fonction qui télécharge l'ensemble des parties d'une saison donnée.
```python

def get_regular_season(year:int, out_dir:str) -> dict:
        '''
        Function that retrieves all data for each regular season game of a season.
        It returns a dictionary whose keys correspond to the Game ID of each game.
        '''

        number_of_games = 1230
        if year >= 2017:
            number_of_games = 1271    
        if year == 2020:
            number_of_games = 868 # less games due to Covid

        d = dict()
        for game_number in range( 1 , number_of_games + 1 ):
            game_id = f'{year}02{game_number:04}'
            d[game_id] = get_game(game_id, out_dir)

        return d  

```
   
On peut faire quelque chose de similaire pour télécharger l'ensemble des données pour des finales.

Les ids des finales sont créés différemment. Regardons par exemple le premier match des finales de la saison 2018-2019: 2018030101.

Les 4 premiers chiffres (2018) représente la saison, ici la saison 2018-2019.

Les 2 chiffres suivant (03) représentent le type de partie, ici 03 représente les parties des finales.

Les 4 derniers chiffres (0101) représentent le numéro de la partie, ici le premier chiffre est toujours zéro et ne représente rien, le deuxième représente le round, le troisième le matchup et le quatrième le numéro de la partie.




This post outlines a few more things you may need to know for creating and configuring your blog posts.
If you are interested in more general template features or syntax, you can visit the [Introducing Lanyon]({% post_url 2020-04-03-introducing-lanyon %}) or the [Example Content]({% post_url 2020-04-02-example-content %}) posts.

## Configurations

You should modify some of the default values in `_config.yml`, found in the root directory of this repo.
Things like the title, tagline, description, author information, etc. are all fair game to modify.
Be more careful when modifying the url information - things can break if done incorrectly (these are used if you are deploying via Github pages)

## Creating Posts

To create a new post in the blog, add a new Markdown file to the `_posts/` directory, with the name following the format `YYYY-MM-DD-postname.md`.
Begin the post with the following code:

```markdown
---
layout: post
title: [POST TITLE]
---
```

From there, write your content as you would a normal Markdown file.
In general, I would recommend writing one sentence per line. 
This is not required, but this is far easier to work with than having a single giant line of multiple sentences for a single paragraph.

## Interactive plots

Here's how you could embed interactive figures that have been exported as HTML files.
Note that we will be using plotly for this demo, but anything that allows you to HTML should work.
All that's required is for you to export your figure into HTML format, and make sure that the file exists in the `_includes` directory in this repository's root directory.
To embed it into any page, simply insert the following code anywhere into your page.

```markdown
{% raw %}{% include [FIGURE_NAME].html %}{% endraw %} 
```

For example, the following code can be used to generate the figure underneath it.

```python
import pandas as pd
import plotly.express as px

df = pd.read_csv('https://raw.githubusercontent.com/plotly/datasets/master/earthquakes-23k.csv')

fig = px.density_mapbox(df, lat='Latitude', lon='Longitude', z='Magnitude', radius=10,
                        center=dict(lat=0, lon=180), zoom=0,
                        mapbox_style="stamen-terrain")
fig.show()

fig.write_html('./_includes/plotly_demo_1.html')
```

{% include plotly_demo_1.html %}


The above figure is pretty cool, but you can also embed heavier/more complex figures.
For brevity, the following figure is generated from the included `plotly_html.ipynb` notebook file in the repo's root directory.

{% include plotly_demo_2.html %}
